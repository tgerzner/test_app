<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="user-scalable=no,initial-scale=1, maximum-scale=1,minimum-scale=1, width=device-width" />
        <title>PhoneGap Application</title>
        <link rel="stylesheet" href="css/jquery.mobile-1.3.2.css" />
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/jquery.mobile-1.3.2.min.js"></script>
        <script src="js/main.js"></script>
        <script src="cordova.js"></script>
        <script type="text/javascript">
            // Wait for PhoneGap to load
            document.addEventListener("deviceready", onDeviceReady, false);

            // PhoneGap is ready
            function onDeviceReady() {
            }


            //Get Photo
            function getPhoto(source){
                alert("GetPhoto")
                navigator.camera.getPicture(onPhotoURISuccess,onError,{
                    quality:50,
                    destinationType: destinationType.FILE_URL,
                    sourceType: source,
                    saveToPhotoAlbum: true
                });
            }

            function displayPhotos(){
                alert("load Photo")
                var uriImage = document.getElementById('dataImage');
                uriImage.style.display = 'block';
                imageURI = ""
                //Photos aus dem lokalen Speicher holen

                for (var i = 0; i < localStorage.length; i++){
                    alert(localStorage.key(i));
                    if (localStorage.key(i).split("_",1) == "SeeYou"){
                        imageURI = localStorage.getItem(localStorage.key(i));
                        alert(imageURI)
                    }
                }
                if (imageURI == ""){
                    alert("no Picture")
                }
                else{
                    uriImage.src= imageURI;
                }
            }

            //If we get an image
            function onPhotoURISuccess(imageURI){
                alert("onPhotoSucces")

                //Pfad in den lokalen Speicher kopieren
                lat, lon = get_geolocation()
                var newDate = new Date();
                var photoId = newDate.getTime();
                photoId = "SeeYou_" + lat + "_" + lon + "_" + photoId
                alert(photoId)
                try {
                    localStorage.setItem(photoId, imageURI);
                    alert("Photo gespeichert")
                } catch (e) {
                    if (e == QUOTA_EXCEEDED_ERR) {
                        alert('Quota exceeded!');
                    }
                }
                // Kommentar entfernen um direkt beim Photoschiessen das Bild hochzuladen
                photo_upload(imageURI);
            }

            //Handle Errors
            function onError(error){
                alert("Error: " + error);
            }

            // Direkter Upload beim Photoschiessen
            function photo_upload(imageURI) {
                var options = new FileUploadOptions();
                options.fileKey="file";
                options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
                options.mimeType="image/jpeg";

                var params = new Object();
                params.value1 = "test";
                params.value2 = "param";

                options.params = params;
                options.chunkedMode = false;
                var ft = new FileTransfer();

                ft.upload(imageURI,
                    "http://see--you.ch/photos/upload.php",
                    function(result) {
                        console.log('Upload success: ' + result.responseCode);
                        console.log(result.bytesSent + ' bytes sent');
                        alert("Wuuuuuuhuu")
                    },
                    function(error) {
                        alert("Fail")
                        alert(error.code)
                        alert(error.source)
                        alert(error.target)
                        alert(error.msg)
                        alert(error)
                    },
                    options);
            }

            //Upload To Server
            function uploadPhotos() {
                for (var i = 0; i < localStorage.length; i++){
                    alert(localStorage.key(i));
                    if (localStorage.key(i).split("_",1) == "SeeYou"){
                        imageURI = localStorage.getItem(localStorage.key(i));
                        alert(imageURI);
                        photo_upload(imageURI);

                    }
                }
            }

            function deletePhotos(){
                localStorage.clear()
            }

            //Get Location
            function get_geolocation(){
                console.log('Get Geolocation');
                lat, lon = navigator.geolocation.getCurrentPosition(geoloc_onSuccess, geoloc_onError);
                return lat, lon
            }

            // Get lat, lon, time
            function geoloc_onSuccess(position) {
                var lat = position.coords.latitude
                var lon = position.coords.longitude
                var time = position.coords.timestamp
                console.log(time);
                console.log(lat);
                console.log(lon);
                return lat, lon
            }

            // If an error occurs
            function geoloc_onError(error) {
                var errString = '';
                if (error.code) {
                    switch (error.code) {
                        case 1:
                            errString =
                                    'We do not have permission';
                            break;
                        case 2:
                            errString =
                                    'The location can not be determined';
                            break;
                        case 3:
                            errString =
                                    'There was a timeout';
                            break;
                        default:
                            errString =
                                    'Unknown error';
                            break
                    }
                }
            }



        </script>
    </head>
    <body>
        <div data-role="page">
            <div data-role="header">
                <h1>See You</h1>
            </div><!-- /header -->

            <div data-role="content">
                <button onclick="getPhoto()">Get Photo</button>
               <br />
                <button onclick="displayPhotos()">Display Photos</button>
               <br />
                <img style="display: none;width: 200px;height: 190px;" id="dataImage" src="" />
                <br />
                <button onclick="uploadPhotos()">Upload Photos</button>
               <br />
                <button onclick="deletePhotos()">Delete Photos</button>
               <br />

                 <button onclick="get_geolocation();">Get Geolocation</button>
                <br />

                <div id="message"></div>
                <br />
            </div><!-- /content -->
            <div id="footer" data-role="footer">
                <h4><span>Copyright &copy; 2014</span></h4>
            </div><!-- /footer -->
        </div><!-- /page -->
    </body>
</html>
