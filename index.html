<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="user-scalable=no,initial-scale=1, maximum-scale=1,minimum-scale=1, width=device-width" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>PhoneGap Application</title>
        <link rel="stylesheet" href="css/jquery.mobile-1.3.2.css" />
        <script src="js/jquery-1.10.2.min.js"></script>
        <script src="js/jquery.mobile-1.3.2.min.js"></script>
        <script src="js/main.js"></script>
        <script src="cordova.js"></script>
        <script type="text/javascript">
            //Parameter
            lat = 0;
            lon = 0;

            // Wait for PhoneGap to load
            document.addEventListener("deviceready", onDeviceReady, false);

            // PhoneGap is ready
            function onDeviceReady() {
                var project = localStorage.getItem("project");
                if (project!=null){
                    $('button#project').innerHTML = "Von Projekt abmelden";
                    document.getElementById("project").innerHTML = "Abmelden"
                    $("#project").val("Abmelden").button("refresh");
                    document.getElementById("title").innerHTML = "See You : " + project
                }
                else{
                    document.getElementById("project").innerHTML = "An Projekt anmelden";
                    $("#project").val("An Projekt anmelden").button("refresh");
                }

            }


            //Get Photo
            function getPhoto(source){
                navigator.camera.getPicture(onPhotoURISuccess,onError,{
                    quality:50,
                    destinationType: destinationType.FILE_URL,
                    sourceType: source,
                    saveToPhotoAlbum: true
                });
            }

            function displayPhotos(){
                var uriImage = document.getElementById('dataImage');
                uriImage.style.display = 'block';
                imageURI = ""
                //Photos aus dem lokalen Speicher holen

                for (var i = 0; i < localStorage.length; i++){
                    if (localStorage.key(i).split("_",1) == "SeeYou"){
                        imageURI = localStorage.getItem(localStorage.key(i));
                    }
                }
                if (imageURI == ""){
                    alert("no Picture")
                }
                else{
                    uriImage.src= imageURI;
                }
            }

            //If we get an image
            function onPhotoURISuccess(imageURI){
                alert("onPhotoSucces")

                //Pfad in den lokalen Speicher kopieren
                get_geolocation(imageURI)

            }

            function save_photo(imageURI, lat, lon){
                var newDate = new Date();
                var photoId = newDate.getTime();
                photoId = "SeeYou_" + lat + "_" + lon + "_" + photoId
                try {
                    localStorage.setItem(photoId, imageURI);
                    alert(photoId)
                    alert(imageURI)
                    alert("Photo gespeichert")
                } catch (e) {
                    if (e == QUOTA_EXCEEDED_ERR) {
                        alert('Quota exceeded!');
                    }
                }
                // Kommentar entfernen um direkt beim Photoschiessen das Bild hochzuladen
/*                var project = localStorage.getItem("project");
                if (project != null){
                    photo_upload(photoId, imageURI, project);
                }
                else{
                    alert("Bitte melden sie sich zuerst an ein Projekt an")
                }*/
            }

            //Handle Errors
            function onError(error){
                alert("Error: " + error);
            }

            // Direkter Upload beim Photoschiessen
            function photo_upload(photoId, imageURI, project) {
                var options = new FileUploadOptions();
                options.fileKey="file";
                options.fileName=imageURI.substr(imageURI.lastIndexOf('/')+1);
                options.mimeType="image/jpeg";

                var params = new Object();
                params.value1 = photoId;
                params.value2 = project;

                options.params = params;
                options.chunkedMode = false;
                var ft = new FileTransfer();

                ft.upload(imageURI,
                    "http://see--you.ch/photos/upload.php",
                    function(result) {
                        console.log('Upload success: ' + result.responseCode);
                        console.log(result.bytesSent + ' bytes sent');
                        alert("Wuuuuuuhuu")
                    },
                    function(error) {
                        alert("Fail")
                    },
                    options);
            }

            //Upload To Server
            function uploadPhotos() {
                var project = localStorage.getItem("project");
                if (project != null){
                    for (var i = 0; i < localStorage.length; i++){
                        if (localStorage.key(i).split("_",1) == "SeeYou"){
                            imageURI = localStorage.getItem(localStorage.key(i));
                            photo_upload(localStorage.key(i), imageURI, project);

                        }
                    }
                }
                else{
                    alert("Bitte melden sie sich zuerst an ein Projekt an")
                }
            }

            function deletePhotos(){
                for (var i = 0; i < localStorage.length; i++){
                    if (localStorage.key(i).split("_",1) == "SeeYou"){
                        localStorage.removeItem(localStorage.key(i))
                    }
                }
            }

            //Get Location
            function get_geolocation(imageURU){
                lat, lon = navigator.geolocation.getCurrentPosition(geoloc_onSuccess, geoloc_onError);
                return lat, lon

                // Get lat, lon, time
                function geoloc_onSuccess(position) {
                    lat = position.coords.latitude
                    lon = position.coords.longitude
                    console.log(lat);
                    console.log(lon);
                    alert(lat)
                    save_photo(imageURI, lat, lon)
                }

                // If an error occurs
                function geoloc_onError(error) {
                    var errString = '';
                    if (error.code) {
                        switch (error.code) {
                            case 1:
                                errString =
                                        'We do not have permission';
                                break;
                            case 2:
                                errString =
                                        'The location can not be determined';
                                break;
                            case 3:
                                errString =
                                        'There was a timeout';
                                break;
                            default:
                                errString =
                                        'Unknown error';
                                break
                        }
                    }
                }
            }

            function get_project(){
                var project = localStorage.getItem("project");
                if (project == null){
                    var proj=prompt("Geben sie bitte das ProjektkÃ¼rzel ein","");
                    if (proj!=null){
                        localStorage.setItem("project", proj);
                    }
                    document.getElementById("project").innerHTML = "Abmelden";
                    $("#project").val("Abmelden").button("refresh");
                    document.getElementById("title").innerHTML = "See You : " + proj
                }
                else{
                    localStorage.removeItem("project")
                    document.getElementById("project").innerHTML = "An Projekt anmelden";
                    $("#project").val("An Projekt anmelden").button("refresh");
                    document.getElementById("title").innerHTML = "See You"
                }
                $("#project").val("gfhf").button("refresh");
            }

        // Todo
        // Anmeldung beim Server mit Projektkuerzel und Passwort
        // Geolocation in den Dateinamen schreiben
        // Datei in den richtigen Ordner schreiben
        // Bild in See You darstellen
        // Photogallerie ????
        // Styling

        </script>
    </head>
    <body>
        <div data-role="page">
            <div data-role="header">
                <h1 id="title">See You</h1>
            </div><!-- /header -->

            <div data-role="content">
                <button onclick="getPhoto()">Get Photo</button>
               <br />
                <button onclick="displayPhotos()">Display Photos</button>
               <br />
                <img style="display: none;width: 200px;height: 190px;" id="dataImage" src="" />
                <br />
                <button onclick="uploadPhotos()">Upload Photos</button>
               <br />
                <button onclick="deletePhotos()">Delete Photos</button>
               <br />
                <button id="project" onclick="get_project();" >An Projekt anmelden</button>
                <br />

                <div id="message"></div>
                <br />
            </div><!-- /content -->
            <div id="footer" data-role="footer">
                <h4><span>Copyright &copy; 2014</span></h4>
            </div><!-- /footer -->
        </div><!-- /page -->
    </body>
</html>
